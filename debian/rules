#!/usr/bin/make -f
# -*- makefile -*-

include /usr/share/cdbs/1/rules/debhelper.mk
include /usr/share/cdbs/1/class/makefile.mk
include /usr/share/cdbs/1/rules/utils.mk

EPICS_HOST_ARCH:=$(shell /usr/lib/epics/startup/EpicsHostArch)

# chop out the source version from Changelog (ie 1.12.20)
SOV=$(shell echo "$(DEB_NOEPOCH_VERSION)"| cut -f 1 -d '-')

ENV=EPICS_HOST_ARCH=$(EPICS_HOST_ARCH)

DEB_MAKE_ENVVARS = PATH="$(CURDIR)/extensions/bin/$(EPICS_HOST_ARCH):$$PATH" \
LD_LIBRARY_PATH="$(CURDIR)/extensions/lib/$(EPICS_HOST_ARCH):$$LD_LIBRARY_PATH"

DEB_MAKE_MAKEVARS = EPICS_HOST_ARCH=$(EPICS_HOST_ARCH) USE_RPATH=NO \
SHRLIB_VERSION=$(SOV) ABS_INSTALL_DIR=/usr/lib/epics

# Prevent CFLAGS and similar from being passed to EPICS since
# this will break cross-builds of things.
DEB_MAKE_INVOKE  = $(DEB_MAKE_ENVVARS) $(MAKE) -C $(DEB_BUILDDIR) $(DEB_MAKE_MAKEVARS)

DEB_BUILDDIR=extensions/src/SDDS

post-patches:: ./extensions/configure

./extensions/configure:
	ln -s /usr/lib/epics/extensions/configure ./extensions/

move-src: move-src-stamp

clean::
	rm -f move-src-stamp

DEB_MAKE_CLEAN_TARGET =
DEB_MAKE_BUILD_TARGET = all
DEB_MAKE_INSTALL_TARGET = all INSTALL_LOCATION=$(CURDIR)/debian/tmp/usr/lib/epics
DEB_MAKE_CHECK_TARGET =

# Build Rules

binbuild=$(CURDIR)/extensions/bin/$(EPICS_HOST_ARCH)
libbuild=$(CURDIR)/extensions/lib/$(EPICS_HOST_ARCH)

clean::
	rm -f ./extensions/configure
	rm -rf ./extensions/bin ./extensions/include ./extensions/lib/$(EPICS_HOST_ARCH)
	find . -name 'O.*' -type d|xargs rm -rf

# Install Rules

instroot=$(CURDIR)/debian/tmp
bindir=$(instroot)/usr/bin
libdir=$(instroot)/usr/lib
confdir=$(instroot)/etc
datadir=$(instroot)/usr/share/sdds
docdir=$(instroot)/usr/share/doc/sdds

epicsroot=$(instroot)/usr/lib/epics
epicslibs=$(epicsroot)/lib/$(EPICS_HOST_ARCH)
epicsbins=$(epicsroot)/bin/$(EPICS_HOST_ARCH)
epicsincl=$(epicsroot)/include

install/sdds-dev::
	install -d $(bindir)
	install -d $(libdir)/sdds
	install -d $(datadir)
	install -d $(confdir)/sdds

	# Basic libraries go in /usr/lib/epics/lib
	for ff in $(epicslibs)/*.so;do \
		mv $$ff.$(SOV) $(libdir)/; \
		rm -f $$ff; \
		ln -s ../../../../lib/`basename $$ff`.$(SOV) $$ff; \
	done

install/sdds-util::
	install -d $(bindir)
	install -d $(libdir)/sdds
	install -d $(datadir)
	install -d $(confdir)/sdds
	install -d $(epicsbins)
	install -m 644 defns.rpn $(confdir)/sdds/defns.rpn

	# Basic libraries go in /usr/bin
	for ff in $(epicsbins)/*;do \
		ln -s ../lib/epics/bin/$(EPICS_HOST_ARCH)/`basename $$ff` $(bindir)/`basename $$ff`; \
	done
